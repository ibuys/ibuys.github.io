<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>jb… | Parsing iostat Results</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Parsing iostat Results">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://jonathanbuys.com/Parsing_IOStat_Results/">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="jb…">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="https://jonathanbuys.com/Parsing_IOStat_Results/">
  <meta name="twitter:title" content="Parsing iostat Results">
  <meta name="twitter:description" content="">

  
    <meta property="og:image" content="https://jonathanbuys.com/assets/og-image-ee46bbc61b334e821e81534b1fd43f3fee6f020ec174b3c2114445695fd48c01.jpg">
    <meta name="twitter:image" content="https://jonathanbuys.com/assets/og-image-ee46bbc61b334e821e81534b1fd43f3fee6f020ec174b3c2114445695fd48c01.jpg">
  

  <link href="https://jonathanbuys.com/atom.xml" type="application/rss+xml" rel="alternate" title="jb… Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-light-212606391baaa7b16463b92b3c519b56832ab53456441e045807984cad648a1e.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon-light-87d1f2a3a19b1500e5c1626a0492025ca5f7f97d24540dc5900288e92112925a.png">
      <link rel="stylesheet" type="text/css" title="light" id="light" href="/assets/light-7f522908aad16b87e703f470834aceb4a7ff176aa3d0ea38bc79efa11ac38c6d.css">
      <link rel="stylesheet" type="text/css" title="dark" id="dark" href="/assets/dark-02e2f267b21f6c4c71f528ac48c0e6b6680d4c968ac2a5fa52e4f416874e52a4.css" disabled="true">
    

  
  
</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav ">
  <a href="/" class="header-logo" title="jb…">jb…</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
  <use href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about" xlink:href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="/microblog/" title="Chirp, chirp">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/ibuys" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="/atom.xml" rel="noreferrer noopener" target="_blank" title="RSS">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-rss">
  <use href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss" xlink:href="/assets/rss-541ec5cea9cefd10d2fcfec01888f3f231a8829940249835fa7b7b3a12ae0d0d.svg#icon-rss"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a onclick="toggle()" title="Toggle Theme">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-theme">
  <use href="/assets/theme-66869e0bf8dab34bae1c86bda400327b772e0be69e8dc28d3ede896e771320ed.svg#icon-theme" xlink:href="/assets/theme-66869e0bf8dab34bae1c86bda400327b772e0be69e8dc28d3ede896e771320ed.svg#icon-theme"></use>
</svg>

        </a>
      </li>
    
  </ul>
</nav>

        <article class="article ">
          <header class="article-header">
            <h1>Parsing iostat Results</h1>
            <p></p>
            <div class="article-list-footer">
              <span class="article-list-date">
                January 25, 2014
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  3 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/linux">linux</a>
                
                  <a href="/tag/sysadmin">sysadmin</a>
                
                  <a href="/tag/statistics">statistics</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p>In the course of load testing a new system, we gathered the output from <a href="http://man.cx/iostat">iostat</a> from a group of servers. In addition to parsing through the device statistics, we thought it would be handy to graph the CPU stats as well. We set iostat to run every five seconds and captured the output in a text file, one per server. This gave me a sizable pool of data, but with everything I needed on separate lines.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Time: 18:00:01
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.79    0.03    0.48    0.06    0.00   98.64

Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
sda               2.22         0.20        38.52    1948442  373500872
sda1              0.00         0.00         0.00      16224       1848
sda2              2.22         0.20        38.52    1931938  373499024</code></pre></figure>

<p>I gathered all the text files into a single directory, and ran a loop in zsh to create a csv file, ready for easy manipulation in any number of programs.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for </span>each <span class="k">in</span> <span class="sb">`</span><span class="nb">ls</span><span class="sb">`</span>
egrep <span class="nt">-A</span> 1 <span class="s1">'(Time)|(avg-cpu)'</span> <span class="nv">$each</span> |sed s/Time<span class="se">\:\ </span>//g | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'\-\-\|avg-cpu'</span> | <span class="nb">paste</span> <span class="nt">-s</span> <span class="nt">-d</span> <span class="s1">'\ \n'</span> - - | <span class="nb">sed</span> <span class="s1">'s/\( \)\{1,\}/,/g'</span> <span class="o">&gt;</span> <span class="nv">$each</span>.csv</code></pre></figure>

<p>I always start building long lines like this one section at a time. Each section is separated by a pipe, (<code class="highlighter-rouge">|</code>), so the first section in the loop calls egrep.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">egrep <span class="nt">-A</span> 1 <span class="s1">'(Time)|(avg-cpu)'</span> <span class="nv">$each</span></code></pre></figure>

<p>This command alone give us output that looks like this:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Time: 00:03:39
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.20    0.00    0.10    0.00    0.00   99.70
<span class="nt">--</span>
Time: 00:03:44
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.10    0.00    0.20    0.00    0.00   99.70</code></pre></figure>

<p>The “-A” flag on the egrep command tells egrep to get both the matching line in the text and the line directly below it. The section between the single tics, searches for either “Time” or “avg-cpu”. This gives me the time and the CPU statistics I’m interested in. Next, I pipe this output to the next section, a <a href="http://man.cx/sed">sed</a> command that strips out the “Time” string, so our command now looks like:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">egrep <span class="nt">-A</span> 1 <span class="s1">'(Time)|(avg-cpu)'</span> iostat.ba-rec1  |sed s/Time<span class="se">\:\ </span>//g </code></pre></figure>

<p>And gives us output like:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">00:04:14
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.00    0.00    0.10    0.00    0.00   99.90
<span class="nt">--</span>
00:04:19
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.40    0.00    0.30    0.00    0.00   99.30</code></pre></figure>

<p>The next section uses grep with the “-v” flag, which tells grep to reverse it’s normal behavior and only return the strings that do <em>not</em> match the search text.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">egrep <span class="nt">-A</span> 1 <span class="s1">'(Time)|(avg-cpu)'</span> iostat.ba-rec1  |sed s/Time<span class="se">\:\ </span>//g | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'\-\-\|avg-cpu'</span></code></pre></figure>

<p>The grep command is looking for either “avg-cpu” or two dashes and removing both lines, giving us:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">00:04:14
           0.00    0.00    0.10    0.00    0.00   99.90
00:04:19
           0.40    0.00    0.30    0.00    0.00   99.30</code></pre></figure>

<p>This is looking much better, but the lines of text are offset from what I need them to be. A post I read recently by <a href="http://www.leancrew.com/all-this/2013/11/two-simple-things/">Dr. Drang</a> reminded me of <a href="http://man.cx/paste">paste</a>, which is perfect for this job:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">egrep <span class="nt">-A</span> 1 <span class="s1">'(Time)|(avg-cpu)'</span> iostat.ba-rec1  |sed s/Time<span class="se">\:\ </span>//g | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'\-\-\|avg-cpu'</span> | <span class="nb">paste</span> <span class="nt">-s</span> <span class="nt">-d</span> <span class="s1">'\ \n'</span> - - </code></pre></figure>

<p>Which puts everything on the same line, nice and clean:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">00:04:14            0.00    0.00    0.10    0.00    0.00   99.90
00:04:19            0.40    0.00    0.30    0.00    0.00   99.30</code></pre></figure>

<p>Only thing left now is to clean up the excess spaces a bit and separate each column by commas, another job for sed, which is only slightly modified from this post on <a href="http://stackoverflow.com/questions/9953448/how-to-remove-all-white-spaces-from-a-given-text-file">StackOverflow</a>, which leads us to the final command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">egrep <span class="nt">-A</span> 1 <span class="s1">'(Time)|(avg-cpu)'</span> iostat.ba-rec1  |sed s/Time<span class="se">\:\ </span>//g | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'\-\-\|avg-cpu'</span> | <span class="nb">paste</span> <span class="nt">-s</span> <span class="nt">-d</span> <span class="s1">'\ \n'</span> - - | <span class="nb">sed</span> <span class="s1">'s/\( \)\{1,\}/,/g'</span></code></pre></figure>

<p>Which I redirect the output of to a text file, one per server, just like the input from the loop. This, finally, gives us the csv output we were looking for:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">00:04:14,0.00,0.00,0.10,0.00,0.00,99.90
00:04:19,0.40,0.00,0.30,0.00,0.00,99.30</code></pre></figure>

<p>Now it is ready.</p>


          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=Parsing+iostat+Results%20-%20https://jonathanbuys.com/Parsing_IOStat_Results/%20by%20@ibuys" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://jonathanbuys.com/Parsing_IOStat_Results/" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
            <a href="https://plus.google.com/share?url=https://jonathanbuys.com/Parsing_IOStat_Results/" title="Share on Google+" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 128 128"><path d="M40.7 55.9v16.1c0 0 15.6 0 22 0C59.2 82.5 53.8 88.2 40.7 88.2c-13.3 0-23.7-10.8-23.7-24.2s10.4-24.2 23.7-24.2c7.1 0 11.6 2.5 15.8 5.9 3.3-3.3 3.1-3.8 11.6-11.9 -7.2-6.6-16.8-10.6-27.4-10.6C18.2 23.3 0 41.5 0 64c0 22.5 18.2 40.7 40.7 40.7 33.6 0 41.8-29.3 39-48.8H40.7zM113.9 56.7V42.6h-10.1v14.1H89.4v10.1h14.5v14.5h10.1V66.8H128V56.7H113.9z"/></svg>
            </a>
          </div>

          
        </article>
        <footer class="footer ">
  <p>
Copyright © 2007-2019 Jonathan Buys
  </p>
  <p>
  ISSN: 2161-8119
  </p>
</footer>

      </div>
    </div>
  </main>
  <script src="/assets/vendor-0fb4b91f7ad6c193a69224eba7a01b691a2d7528ee672607575ccc0df3aea545.js" type="text/javascript"></script>


  <script src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js" type="text/javascript"></script>




<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>


  <script src="/assets/themetoggle-df0d3d73164dc26dffbd630182ae4d0dfa7bee6b694a2b5d565d73595b582bbf.js" type="text/javascript"></script>

</body>
</html>
