I"Ì<p>Where I spend my days ($WORK), we have multiple monitoring systems for just about every service on every server that we have.  Many of these are <a href="http://www.nagios.org/">Nagios</a>, some are built in, and others are <a href="https://h10078.www1.hp.com/cda/hpms/display/main/hpms_content.jsp?zn=bto&amp;cp=1-11-15-25%5E849_4000_100__">SiteScope</a>.  All of the systems generate email alerts that either go to our pagers, our email, or both.  From time to time, management would ask a question like ‚ÄúHow many pages do you get in a week on average‚Äù, which up till a couple of months ago, our answer was always ‚ÄúIt just depends‚Äù.</p>

<p>Not a great answer, so I decided to start tracking the email alerts with a centralized database.  Now, at this point, I could have whipped up my own home-brew frankenstein creation, but since everything I wanted was already built into Wordpress, I really didn‚Äôt need to.  Wordpress has the option of posting blogs via email.  So, all I needed to do was set up a special email account on our mail server and make sure the pop3 server was running.  Then, add the server and login information into Wordpress, setup a cron job to trigger the mail check every five minutes, and there.  Instant logging of all pages that are sent out in a searchable, easy to read, web format.  Now, when management gets it in their mind to start asking questions, we can easily say ‚ÄúLet me reference my report.‚Äù They really like hearing things like that.</p>

<p>Building on the success of the alert log, I thought it might be good to also log all of our changes to the system.  This idea is completely different from traditional ‚ÄúChange Management‚Äù systems which require you to log ahead of time what you want to accomplish in some ridiculous form or application.  Instead, I find it much more useful and relevant to build in the change logging where we spend most of our time, the command line.</p>

<p>I‚Äôve added an alias for ‚Äúexit‚Äù in the shell like so:
    alias exit=‚Äùexec /scripts/ch_log‚Äù
Here is the ch_log script:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="c"># ch_log - Prompt the user to log system changes on</span>
<span class="c"># exit from the root shell.</span>
<span class="c">#</span>
<span class="c"># jonbuys@os-zen.com - Wed Apr  2 15:32:43 CDT 2008</span>
<span class="c">#</span>
<span class="c">############################################################</span>

<span class="nv">HOST</span><span class="o">=</span><span class="sb">`</span><span class="nb">hostname</span><span class="sb">`</span>
<span class="nv">DATE</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> +%m-%d-%y<span class="sb">`</span>
<span class="nb">echo</span> <span class="nv">$DATE</span>
<span class="nb">echo</span> <span class="s2">"Did you make any changes to the system? (y/n)"</span>
<span class="nb">read </span>answer

<span class="k">if</span> <span class="o">[</span> <span class="nv">$answer</span> <span class="o">==</span> n <span class="o">]</span> <span class="p">;</span> <span class="k">then
   </span><span class="nb">echo</span> <span class="s2">"OK, Thanks!"</span>
   <span class="nb">exit </span>0
<span class="k">else
   </span><span class="nb">echo</span> <span class="s2">"Cool, please enter your name, and then describe the changes in the form."</span>
   <span class="nb">echo</span> <span class="s2">"Name:"</span>
   <span class="nb">read </span>NAME

    <span class="nb">cat</span> /scripts/log_template | <span class="nb">sed </span>s/NNN/<span class="nv">$NAME</span>/g | <span class="nb">sed </span>s/DDD/<span class="nv">$DATE</span>/g | <span class="nb">sed </span>s/SSS/<span class="nv">$HOST</span>/g <span class="o">&gt;</span> /tmp/<span class="nv">$$</span>.answer
    vi /tmp/<span class="nv">$$</span>.answer
    mail change_log@mail.mydomain.com <span class="nt">-s</span> <span class="s2">"Change Notification for </span><span class="nv">$HOST</span><span class="s2">"</span>&amp;lt<span class="p">;</span> /tmp/<span class="nv">$$</span>.answer
    <span class="nb">echo</span> <span class="s2">"OK, thanks!"</span>
<span class="k">fi
</span><span class="nb">exit </span>0

<span class="c">############################################################</span>
<span class="c"># EOF: ch_log</span>
</code></pre></div></div>

<p>Basically, when we exit our shell we now have to make a choice‚Ä¶ do we log what we did with this quick and easy script, or do we ignore it and risk the consequences.  I‚Äôve found that for the most part, I choose to log my work.  The email that is sent off to the change_log@mail.mydomain.com address is picked up by a second Wordpress install, and posted to the blog.  Now we have a historical record of what we‚Äôve done incase something breaks, or (more importantly) when annual review time comes around and we are asked ‚Äúwhat have you been up to‚Äù</p>

<p>There is one other change that I had to make to get this to work right.  By default, Wordpress holds all posts it recieves via email for approval before posting it to the main page.  This is good security, but not really needed on an internal LAN, and it breaks the system I‚Äôve laid out above.  So, to fix it, I‚Äôve made a slight change to the wp-mail.php file:
     // Set $post_status based on $author_found and on author‚Äôs publish_posts capability
     if ($author_found) {
             $user = new WP_User($post_author);
             if ($user-&gt;has_cap(‚Äòpublish_posts‚Äô))
                     $post_status = ‚Äòpublish‚Äô;
             else
                     $post_status = ‚Äòpublish‚Äô;
     } else {
             // Author not found in DB, set status to pending.  Author already set to admin.
             $post_status = ‚Äòpublish‚Äô;
     }</p>

<p>Above, I‚Äôve changed the ‚Äúpending‚Äù post_status to ‚Äúpublish‚Äù for unidentified users, which is everything that it receives via email.  This is a very bad idea to do outside of the LAN, but I don‚Äôt see any harm in it internally.  Undoubtedly there are those who would disagree, but this works well for us.</p>

<p>This is how we are using Wordpress internally on our corporate LAN right now, I‚Äôd be interested to hear how some others are using Wordpress or other blogging software.</p>
:ET